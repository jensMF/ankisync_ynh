#!/bin/bash

set -e

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source /usr/share/yunohost/helpers
source ./_common.sh

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================
# The app version from the manifest
app_version=$(echo "$version" | cut -d'~' -f1)

ynh_app_setting_set --key=app_version --value="$app_version"
ynh_app_setting_set --key=admin_user --value="$admin_user"
# We do not store the password in the main settings file for security reasons.

# Set permissions on data directory, which is created by YunoHost core
chown -R "$app:$app" "$data_dir"

#=================================================
# DOWNLOAD AND BUILD SOURCE
#=================================================
ynh_script_progression "Building Anki sync server from source... (this may take a while)"

# We use cargo install to build and install the binary from the git repository.
# The --root option specifies the installation directory.
# We run this as root because cargo needs to write to system-wide directories as well.
# Permissions will be fixed later.
ynh_exec_as root cargo install --locked --git https://github.com/ankitects/anki.git --tag "$app_version" anki-sync-server --root "$install_dir"

# The binary is installed in $install_dir/bin/anki-sync-server.
# We move it to the root of the install directory for simplicity.
mv "$install_dir/bin/anki-sync-server" "$install_dir/anki-sync-server"

# Clean up the installation directory
rm -rf "$install_dir/bin" "$install_dir/.crates.toml" "$install_dir/.crates2.json"

# Set permissions on install directory
chown -R "$app:$app" "$install_dir"
chmod +x "$install_dir/anki-sync-server"


#=================================================
# APP INITIAL CONFIGURATION
#=================================================
ynh_script_progression "Adding $app's configuration files..."

# Create the configuration directory
config_dir="/etc/yunohost/apps/$app/conf"
mkdir -p "$config_dir"

# Create the environment file
env_file="$config_dir/ankisync.env"

# Hash the admin password
ynh_script_progression "Hashing admin password..."
local hashed_password
hashed_password=$(echo -n "$admin_password" | argon2-cli -e)

# Write initial configuration to the env file
cat > "$env_file" << EOF
PASSWORDS_HASHED=1
SYNC_USER1=${admin_user}:${hashed_password}
SYNC_BASE=${data_dir}
SYNC_HOST=127.0.0.1
SYNC_PORT=${port}
EOF

# Set ownership of the config dir and env file
chown -R "$app:$app" "$config_dir"

# The user list for the config panel is read directly from the environment file,
# so we don't need to store it in the app settings.


#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Configuring system for $app..."

# Create a dedicated NGINX config using the conf/nginx.conf template
ynh_config_add_nginx

# Create a dedicated systemd config using the conf/systemd.service template
ynh_config_add_systemd

# Add the service to YunoHost
yunohost service add "$app" --description="Anki sync server for $app" --log="/var/log/$app/$app.log"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's service..."

# Start and enable the systemd service
ynh_systemctl --service="$app" --action="start"
ynh_systemctl --service="$app" --action="enable"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
